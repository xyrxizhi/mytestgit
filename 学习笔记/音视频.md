## 音视频杂项笔记
### 视频

RGB格式：
每个像素点用三原色来表示
YUV格式：
&emsp;Y表示明亮度，UV表示色度，色度又分为色调课饱和度
&emsp;Y可单独表示一张黑白图像
&emsp;对于YUV格式，根据不同的采样方式，不是每个像素点都同时需要YUV三个分量表示，所以传输过程中使用YUV格式更省带宽
&emsp;YUV的存储格式可以把每个像素点放在一起存储，也可以把YUV当做三个独立平面存储
&emsp;YUV格式由采样方式和存储格式共同决定
YUV和RGB可以相互转换
#### H264编码
主要压缩技术
&emsp;帧内预测压缩，帧间预测压缩，整数离散余弦变换，CABAC压缩
压缩后的帧分别是I帧，P帧，B帧
压缩过程
* 把画面划分成若干个16\*16或8\*8的的宏块
* 计算宏块的像素值
* 为了更高的压缩率可以在宏块的基础上继续划分子块
* 对帧进行分组
>视频数据主要有两类时间冗余和空间冗余，大部分是时间冗余。有些相邻的帧可能信息差异只在一定限制以内，此时，我们可以把这些帧分到同一组
* 分组后，我们只保留第一帧的完整数据，就是I帧。其他帧都参考上一帧计算出来
* 计算运动矢量与补偿(帧间压缩技术)
* 帧内预测，并把预测结果与原图的残差数据保留以计算原图
* 对残差数据进行整数离散余弦变换
* 最后再做一遍无损压缩
#### 转码
面向数据流流转码
&emsp;实时转码，硬件固化，稳定性高，无法控制转码信息，灵活性差
面向文件转码
&emsp;需要足够大的缓存空间和运算能力
* 对接收到的视频文件或者流进行分块
* 选取一块放入缓存区
* 计算机处理
* 放入指定位置
* 返回步骤二，直到所有块转码完成
* 合并文件片段
&emsp;灵活，不需要数字接口识别类型，软件决定转码方式（编解码类型类型，大小等），对于不同视频源不需要更换硬件
转码软件模块：
数据接口模块、硬件接口模块、存储管理模块、转码算法模块、数据处理模块、控制管理模块和用户界面模块
视频网络传输：
&emsp;受网速限制，按原格式传输所需时长与视频数据时长比值太大
&emsp;专线过于昂贵
&emsp;文件分块拆分，接收后依次合并
&emsp;发送前先压缩至可与目标流类型相互转换的高压缩比文件（牺牲图像质量）
&emsp;可根据网络情况及需求控制文件大小，廉价公用网络，可端点续传，可对单个数据包加密更安全，适合低速网络
RTMP
基于可靠传输层协议，握手建立连接，对信息格式化，把划分块，根据长度信息合并
![](https://upload-images.jianshu.io/upload_images/16305798-1ec2bd472f5c1650.png)
###Chunk Stream
&emsp;块必要信息：时间戳、多媒体信息长度、信息类型、所属流的id
&emsp;分块避免阻塞高优先级信息传输（类比操作系统时间片可抢占）。分块过大导致阻塞；分块过小导致报头信息过多，且不能发挥高宽带优势
块格式
基本报头+信息报头+扩展时间戳+分块数据
* 基本报头（1，2，3字节长）
  * 流id和分块类型（两位）
    * csid0，1，2用户不可自定义 
    * 若基本报头长度为一，那么剩下的位直接表示csid
    * 否则与type相同字节的位默认为64，其他字节表示csid-64。其中与type相同字节的bit，基本报头长度为2是全为0，长度为3时全为1
* 信息报头（根据分块类型划分为4中报头）
  * 类型0
  > * 可表示所有分块类型，长度为11个字节。时间戳后退必须使用此类型
  > * 3字节长度的时间戳，全为1时。使用扩展时间戳表示真正的时间戳
  > * 3字节长度表示实际需要发送数据的长度，指总长度
  > * 1字节长度的信息类型和csid
  * 类型1
    * 与类型0相比没有csid
    * 时间戳用于上次分块的时间差表示
  * 类型2
    * 只有3字节长度的时间差值
    * 表示基本信息与上次分块相同
  * 类型3
    * 0字节，紧接着上次发送的分块，基本信息与上一分块完全相同
    * 跟在type0后面用时间戳，表示时间戳也是相同的，跟在type1或2后面表示与pre的时间差跟pre与pre（pre）的时间差是一样的。
* 扩展时间戳
  * 长度为4个字节
  * 非启用状态全为0，可以选择不发送
* 块数据
协议控制
* message type id = 1
  * Set Chunk Size
  * 控制块中data的最大字节数
  * 此时data第一位必须为0，后面31bit表示新的size大小
* message type id = 2
  * Abort Message
  * data表示某chunk的csid
  * 表示发送方不在发送该chunk，若接收到的chunk不完整则丢弃
* message type id = 3
  * Acknowledgement
  * 收到窗口大小的数据是，反馈给发送方可以继续发送信息的ack。内容包含本次窗口接收到的字节数
* message type id = 4
  * Window Acknowledgement Size
  * 发送方在接收到两个ack之间最多能发送的字节数
* message type id = 5
  * Set Peer Bandwidth
  * 控制对端输出宽带
  * 接受端接收到该消息后会通过设置消息中的Window ACK Size来限制已发送但未接受到反馈的消息的大小来限制发送端的发送带宽。如果消息中的Window ACK Size与上一次发送给发送端的size不同的话要回馈一个Window  Acknowledgement Size的控制消息
  * data为限制值和一个设置等级
    * 等级为0，应该设置 
    * 等级为1，可以设置，可以不变
    * 等级为2，如果上次是等级0，那么按等级0处理，否则忽略
    * 
不同类型的message
* message type id = 17或20
  * 命令信息
  * 返回信息有三种
    * _result接受命令
    * _error拒绝命令
    * method name要求发送端执行指定函数
  * 连接层命令
    * connect连接请求
    * call远程调用函数
    * create stream创建传递信息通道
  * 流连接指令
    * play播放，开始位置，周期，是否重置
    * play2播放，支持切换到统一数据的不同码率
    * delete删除流，告知服务器本地某个流对象已删除
    * receiveAudio是否接收音频
    * receiveVideo是否接收视频
    * publish推送数据
    * seek定位到流的音频或视频某个位置，单位ms
    * pause暂停
* message type id = 15或18
  * 数据信息，某些元数据或用户自定义信息
* message type id = 16或19
  * 共享信息，由键值对集合组成的Flash对象
* message type id = 8
  * 音频信息
* message type id = 9
  * 视频信息
* message type id = 22
  * 聚集信息，多个子信息的集合
* message type id = 4
  * 用户控制信息
![推流过程](https://upload-images.jianshu.io/upload_images/16305798-567406fe7f615e35.png)

![播流过程](https://upload-images.jianshu.io/upload_images/16305798-57cb5d2f85c9a6a7.png)

###FLV
  * 文件头
    * FLV签名3个字节
    * 版本号一个字节
    * 传输类型及音视频信息一个字节
    * 整个文件的长度4个字节
  * 文件体
    * previoustagsize表示前一个tag包括header的大小
    * 下一个tag
    * 下一个previoustagsize交替
  * tag
    * tag类型，数据总大小
    * 相对于第一个时间戳的时间差
    * 流id，tagheader
    * 音频header，视频header
    * data
  * 其中音频header如果是AAC音频格式需要在第一帧的音频格式后面插入一个字节表示AAC的类型
  * 同样视频header如果是AVC格式会多出4个字节信息，其中包活SPS和PPS信息，每次再次start之前需要重发
  * onMetaData包括FLV格式的各种配置信息，比如码率，帧数

###音频格式
####aac格式间的概念上的区别
Advanced Audio Coding(高级音频解码)，是一种由MPEG-4标准定义的有损音频压缩格式，由Fraunhofer发展，Dolby, Sony和AT&T是主要的贡献者。

在使用MP4作为各种内容的容器格式的新多媒体MPEG-4标准中，它是MPEG Layer III / MP3的天然后继者。AAC能够在一条音轨中包括48条全带宽（直到96khz）音频声道，加上15条低频增强（LFE，限制到120Hz）声道，直到15条数据流并且更多。

两者是符合MPEG4 AAC标准的不同配置。 LC意思是"low complexity"(低复杂性) HE意思是 "high efficiency"(高效性) HE-AAC也称之为AAC SBR/AAC+/aacplus等。注意HE-AAC注重于低码流的编码并很适合多声道文件（更小的文件尺寸）。

从学术上讲，HE-AAC混合了AAC与SBR技术。SBR代表的是Spectral Band Replication(频段复制)。SBR的关键是在低码流下提供全带宽的编码而不会产生产生多余的信号。

传统认为音频编码在低码流下意味着减少带宽和降低采样率（见MP3 FAQ #7）或产生令人不快的噪音信号。SBR解决问题的方法是让核心编码去编码低频信号，而SBR解码器通过分析低频信号产生高频信号和一些保留在比特流中的指导信号（通常码流极低，~2kbps）。 这就是采用无SBR解码器的原因，这样你的带宽(frequency Replication的原因，它只是增加音频的带宽，而非重建。 类似MPEG-4视频格式，AAC也有着不同的配置， 其中Low Complexity (LC AAC)配置(MAIN Level 2)最被广泛用于商业市场（例如Apple非常著名的iTunes音乐库）其他有象Long Term Prediction配置(LTP)(长期预测), Scalable Sampling Rate (SSR)(可变采样率) 和Low Delay (LD)(低延迟)。

通常来说低码率源转换可以采用AAC-HE格式； 但是如果你想做出的东西兼容更多设备播放，则强烈建议你采用AAC-LC格式；



